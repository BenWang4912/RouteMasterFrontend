@using RouteMasterFrontend.Models.Dto;
@using System.Text.Json;
@using System.Text.Json.Serialization;
@model FilterDTO

@section Styles{
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.css" />
    <script src="https://kit.fontawesome.com/ad2e9fef09.js" crossorigin="anonymous"></script>
    <link href="~/hotel-datepicker-main/dist/css/hotel-datepicker.css" rel="stylesheet" /><!-- Optional -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    @* <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDr_zVippBk_-dJNEGc5yK8PtX-xE5qZ-w&libraries=&v=weekly" defer></script>  *@

    <style>
        .currentPage {
            background-color: lightgray;
        }

        .wh220 {
            width: 220px;
            height: 220px;
        }

        .w-33 {
            width: 33%;
        }

        .main-left {
            width: 24% !important;
            margin-top: 2px;
        }

        .main-right {
            width: 74% !important;
            padding: 0 !important;
        }

        .modal-xl {
            max-width: 90% !important;
            width: 90%;
            height: 90%;
        }

        .modal-container {
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: center;
        }

        .product-info { /*內含left , right 二個div*/
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: end;
            align-items: start;
        }

            .product-info .left {
                width: 722px;
            }

            .product-info .right {
                width: 55%;
                padding: 10px;
                margin-left: auto;
                overflow: auto;
            }

        .productPhoto {
            object-fit: cover; /*contain 符合指定的寬高比例*/
            width: 100%;
        }

        .product-info .images {
            width: 100%;
            height: 64px;
        }

        .product-info .imageList {
            list-style: none; /* 不顯示項目符號 */
            width: 100%;
            display: flex;
            align-items: center;
            border: 1px solid #ccc;
        }

            .product-info .imageList li {
                margin: 1px;
            }

                .product-info .imageList li img {
                    width: 58px;
                    height: 58px;
                    cursor: pointer;
                    object-fit: cover;
                }

        .li-icon {
            width: 24px;
            height: 24px;
        }
    </style>
    <noscript>
        <style>
            .simplebar-content-wrapper {
                scrollbar-width: auto;
                -ms-overflow-style: auto;
            }

                .simplebar-content-wrapper::-webkit-scrollbar,
                .simplebar-hide-scrollbar::-webkit-scrollbar {
                    display: initial;
                    width: initial;
                    height: initial;
                }
        </style>
    </noscript>
}
<div id="app" v-cloak>

    <div v-if="toggle">
        <div id="RecommendMap" class="ratio ratio-16x9"></div>
        <input type="button" class="btn btn-outline-primary" data-id="index" id=`${product.id}` data-bs-toggle="modal" data-bs-target="#exampleModal" value="搜尋更多住所"/>
    </div>
    <div v-else>
        <div class="d-flex">
            <aside class="main-left border py-1 px-3">
                <div>
                    過透以下分類搜尋：
                </div>
                <div>
                    <h5>住宿評等</h5>
                    <small>包含星級與其他類評等</small>
                    <ul>
                        <li v-for="(grade, index) in filterDto.grades">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="grades" v-bind:id="'grade' + index" v-model="selectedGrades" v-bind:value="grade" @@change="showPages">
                                <label class="form-check-label" v-bind:for="'grade' + index"> {{grade}} 星級</label>
                            </div>
                        </li>
                    </ul>
                </div>
                <div>
                    <h5>住宿類型</h5>
                    <ul>
                        <li v-for="(aCategory,index) in filterDto.acommodationCategories">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="aCategory" v-bind:id="'aCategory' + index" v-model="selectedaCategories" v-bind:value="aCategory" @@change="showPages" />
                                <label class="form-check-label" v-bind:for="'aCategory' + index"> {{aCategory}}</label>
                            </div>
                        </li>
                    </ul>
                </div>
                <div>
                    <h5>評論分數</h5>
                    <ul>
                        <li v-for="(score, index) in filterDto.commentSorce">
                            <div class="form-check">
                                <input type="radio" class="form-check-input" name="score" v-bind:id="'score' + index" v-model="selectedScore" v-bind:value="score" @@change="showPages" />
                                <label class="form-check-label" v-bind:for="'score' + index"> {{score}} 分以上</label>
                            </div>
                        </li>
                    </ul>
                </div>
                <div>
                    <h5>設施與服務</h5>
                    <ul>
                        <li v-for="(sCategory, index) in filterDto.serviceInfoes">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="sCategory" v-bind:id="'sCategory' + index" v-model="selectedsCategories" v-bind:value="sCategory.name" @@change="toggleSInfos(index)">
                                <label class="form-check-label" v-bind:for="'sCategory' + index">{{ sCategory.name }}</label>
                                <div class="ms-4" v-for="(sInfo, sIndex) in sCategory.infos">
                                    <input type="checkbox" class="form-check-input" name="sInfo" v-bind:id="'sInfo' + index + '-' + sIndex" v-model="selectedServiceInfos" v-bind:value="sInfo" @@change="showPages">
                                    <label class="form-check-label" v-bind:for="'sInfo' + index + '-' + sIndex">{{ sInfo }}</label>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
                <div>
                    <h5>直轄縣市</h5>
                    <ul>
                        <li v-for="(region, index) in filterDto.regions">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" name="region" v-bind:id="'region' + index" v-model="selectedaRegions" v-bind:value="region" @@change="showPages" />
                                <label class="form-check-label" v-bind:for="'region' + index"> {{region}} </label>
                            </div>
                        </li>
                    </ul>
                </div>
            </aside>
            <div class="main-right ms-auto">
                <nav class="d-flex row">
                    <input type="search" v-model="keyword" class="form-control w-25 ms-3" placeholder="搜尋關鍵字" @@change="showPages">
                    <div class="d-flex col-3 ms-auto">
                        <label for="page" class="form-label mb-0 me-2 d-flex align-items-center">每頁顯示</label>
                        <select class="form-select w-33" v-model="pageSize" aria-label="Small select example" @@change="showPages">
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="25">25</option>
                        </select>
                        <label for="page" class="form-label mb-0 ms-2 d-flex align-items-center">筆</label>
                    </div>
                </nav>
                <table id="imgTable" class="w-100">
                    <thead>
                        <tr>
                            <th>

                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(product, index) in products" :key="product.id">
                            <td>
                                <div class="row mb-2">
                                    <div class="col">
                                        <div class="card mb-3 h200">
                                            <div class="row g-0 ">
                                                <div class="wh220">
                                                    <img class="card-img card-img-left h-100 w-100" v-bind:src="product.image" style="object-fit:cover" alt="尚未建立住所照片" />
                                                </div>
                                                <div class="col-9">
                                                    <div class="card-body w-100">
                                                        <div class="d-flex align-items-center">
                                                            <h5 class="card-title m-0">
                                                                {{product.name}}
                                                            </h5>
                                                            <span class="score-div bg-primary text-white d-flex justify-content-center align-items-center rounded-2 ms-auto" style="width: 32px; height: 32px; letter-spacing:1px">{{product.grade}}</span>
                                                        </div>
                                                        <p class="card-text">
                                                            <small class="text-muted">
                                                                {{product.address}}
                                                            </small>
                                                        </p>
                                                        <input type="button" class="btn btn-outline-primary" v-bind:data-id="index" v-bind:id=`${product.id}` data-bs-toggle="modal" data-bs-target="#exampleModal" value="住所資訊" @@click="showModal(product.id)" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <hr />
        <nav aria-label="Page navigation example">
            <ul class="pagination justify-content-center flex-wrap mt-2 mb-4">
                <li v-if="hasPrevious" class="page-item">
                    <a class="page-link" href="#" @@click="clickHandler(1)">&lt;&lt;</a>
                </li>
                <li v-if="hasPrevious" class="page-item">
                    <a class="page-link" href="#" @@click="clickHandler(thePage-1)">&lt;</a>
                </li>
                <li v-for="(value, index) in pageRange" :key="index" class="page-item">
                    <a v-if="value === ELLIPSIS" class="page-link d-flex align-items-center">{{ value }}</a>
                    <a v-else :class="{'page-link': true, 'currentPage': value === thePage}" href="#" @@click="clickHandler(value)">{{ value }}</a>
                </li>
                <li v-if="hasNext" class="page-item">
                    <a class="page-link" href="#" @@click="clickHandler(thePage+1)">&gt;</a>
                </li>
                <li v-if="hasNext" class="page-item">
                    <a class="page-link" href="#" @@click="clickHandler(totalPages)">&gt;&gt;</a>
                </li>
            </ul>
        </nav>
    </div>
    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content h-100">
                <div class="modal-header d-f">
                        <h1 class="modal-title fs-2" id="exampleModalLabel"><i class="fa-solid fa-hotel me-3"></i>{{accommodationIndex.name}}</h1>
                        <div class="d-flex">
                            <button class="form-control">總覽</button>
                            <button class="form-control">所有評論</button>
                        </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div v-if="true" class="modal-body">
                    <div class="modal-container h-100">
                        <div class="product-info h-100">
                            <div class="left h-100 mt-2 ms-2">
                                <div class="position-relative w-100">
                                    <div class="w-100 d-flex justify-content-center align-items-center" style="aspect-ratio: auto 1 / 1">
                                        <img v-if="accommodationImage" v-bind:src=`../AccommodationImages/${accommodationImage}` class="productPhoto position-fix" alt="">
                                    </div>
                                    <div class="images" data-simplebar>
                                        <ul class="imageList">
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="right h-100" data-simplebar>
                                <section class="mb-3">
                                    <p class="d-inline-flex gap-1 fs-5">
                                        <a class="" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                                            <i class="fa-solid fa-location-dot"></i>
                                        </a>
                                        <span data-bs-toggle="tooltip" data-bs-title="Default tooltip">
                                            {{accommodationIndex.address}} -
                                        </span>
                                        <a class="" data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                                            顯示地圖
                                        </a>
                                    </p>
                                    <div class="collapse" id="collapseExample">
                                        <div class="card card-body">
                                            @*<iframe src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3617.0436396868013!2d121.21455157595463!3d24.964629841080292!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x346822334db23863%3A0x7ef0842ef1cf8013!2z5Y-k6I-v6Iqx5ZyS6aOv5bqXIEhvdGVsIEt1dmEgQ2hhdGVhdQ!5e0!3m2!1szh-TW!2stw!4v1691261369090!5m2!1szh-TW!2stw" width="100%" height="400" style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>*@
                                            <div id="map" class="ratio ratio-16x9"></div>
                                        </div>
                                    </div>
                                </section>
                                <section class="mb-3 border-top pt-1">
                                    <p class="fs-5" v-html="accommodationDescription" @@click="toggleDescription">
                                    </p>
                                </section>
                                <section class="mb-3 border-top pt-1">
                                    
                                    <dec ref="childRef"></dec>
                                </section>
                                <section class="mb-3 border-top pt-1">
                                    <h2 class="mb-2"><i class="fa-solid fa-bed me-3"></i>客房供應：</h2>

                                    <table class="table table-hover table-success">
                                        <tbody>
                                            <tr v-for="(room, index) in accommodationIndex.rooms" class="row w-100 ms-0">
                                                <td class="col-2 d-flex align-items-center">
                                                    {{room.name}}
                                                </td>
                                                <td class="d-flex col-10">
                                                    <button class="btn btn-warning me-3" data-bs-toggle="collapse" v-bind:id=`collapseBtn${room.id}` v-bind:data-bs-target=`#collapseDatePicker${index}` role="button" aria-expanded="false" aria-controls="collapseDatePicker" @@click.once="createdp(room.id)">訂房</button>
                                                    <div class="collapse" v-bind:id=`collapseDatePicker${index}`>
                                                        <div class="d-flex align-items-center">
                                                            <label v-bind:for=`dp-${room.id}`>日期：</label>
                                                            <input v-bind:id=`dp-${room.id}` type="text" class="form-control me-2" autocomplete="off" placeholder="請選擇日期" readonly style="background:white;width:236px;box-sizing:border-box" />
                                                            <div v-bind:id=`ptInput-${room.id}` style="display:none">
                                                                <div class="d-flex align-items-center">
                                                                    <label v-bind:for=`pq-${room.id}`>數量：</label>
                                                                    <input v-bind:id=`pq-${room.id}` type="number" min="1" value="1" size="2" class="form-control me-2" style="width:63px; box-sizing:border-box" />
                                                                    <label v-bind:for=`tp-${room.id}`>總價：</label>
                                                                    <input v-bind:id=`tp-${room.id}` type="text" value="999999" class="form-control me-3" style="background:white;width:87px; box-sizing:border-box" readonly />
                                                                    <button v-if="toggle" class="btn btn-primary" @@click="addCart(room.id)">加入排程</button>
                                                                    <button v-else class="btn btn-primary" @@click="addCart(room.id)">加入購物車</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </section>
                                <section class="mb-3 border-top pt-1">
                                    <h2 class="mb-2 "><i class="fa-solid fa-award me-3"></i>設施與服務：</h2>
                                    <div class="row d-flex">
                                        <ul v-if="accommodationServiceCId.indexOf(1) !== -1" class="col-4 mb-4">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-van-shuttle"></i>交通與車輛相關
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 1})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(2) !== -1" class="col-4 mb-4">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-wifi"></i>網路與通訊相關
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 2})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(3) !== -1" class="col-4 mb-4">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-tv"></i>休閒與娛樂設施
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 3})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(5) !== -1" class="col-4 mb-4">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-handshake"></i></i>會議與商務設施
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 5})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(6) !== -1" class="col-4 mb-4">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-utensils"></i>餐飲相關設施
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 6})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(7) !== -1" class="col-4 mb-4">
                                            <li>
                                                <i class="me-1 li-icon fa-regular fa-credit-card"></i>金融與支付相關
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 7})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                        <ul v-if="accommodationServiceCId.indexOf(8) !== -1" class="col-4 mb-4">
                                            <li>
                                                <i class="me-1 li-icon fa-solid fa-circle-info"></i>其他
                                            </li>
                                            <li v-for="s in accommodationIndex.services.filter(function(s){return s.serviceInfoCategoryId === 8})"><i class="me-1 li-icon fa-solid fa-check bg-priamry"></i>{{s.name}}</li>
                                        </ul>
                                    </div>
                                </section>
                                <section class="mb-3 border-top pt-1">
                                    <img src="https://static.thenounproject.com/png/2392202-200.png" style="width:24px;height:24px" /> 最早CheckIn時間：{{accommodationIndex.checkIn}}
                                    <img src="https://static.thenounproject.com/png/2392153-200.png" style="width:24px;height:24px" /> 最晚CheckOut時間：{{accommodationIndex.checkOut}}
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
                <div v-else>123</div>
            </div>
        </div>
    </div>

</div>

@section Scripts{
    <script src="https://unpkg.com/vue@3.2.36/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.min.js"></script>
    <script src="~/fecha-4.2.1/fecha-4.2.1/lib/fecha.js"></script>
    <script src="~/hotel-datepicker-main/dist/js/hotel-datepicker.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"
            integrity="sha512-uMtXmF28A2Ab/JJO2t/vYhlaa/3ahUOgj1Zf27M5rOo8/+fcTUVH0/E0ll68njmjrLqOBjXM3V9NiPFL5ywWPQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="~/js/Comments_AccommodationPartial.js"></script>

    <script>
        var vueApp = {
            data() {
                return {
                    //Country:"",
                    keyword: "",
                    products: [],
                    totalPages: 1,
                    thePage: 1,
                    pageSize: 5,
                    filterDto: @Html.Raw(Json.Serialize(Model)),
                    selectedGrades: [],
                    selectedaCategories: [],
                    selectedScore: Number,
                    selectedsCategories: [],
                    selectedServiceInfos: [],
                    selectedaRegions: [],
                    accommodationIndex: {},
                    accommodationImage: "",
                    accommodationDescription: "",
                    cartProductId: [],
                    accommodationServiceCId: [],
                    cartItems: [],
                    map: null,
                    toggle: false,
                }
            },
            created:function(){
                const param = window.location.search
                if(param.includes('?Recommend=') && param.length <= 13 ){
                    this.toggle = true;
                }
            },
            mounted:function () {
                let _this = this;
                if(_this.toggle){
                    // 等待 Google Maps API 加载完成
                    //if (typeof google === 'undefined') {
                    //    setTimeout(function() {
                    //        _this.RecommendAccommodation(1, 1, "");
                    //    }, 100);
                    //    return;
                    //}
                }
                else{
                    _this.loadProducts();
                }
            },
            computed: {
                hasPrevious() {
                    return this.thePage > 1;
                },
                hasNext() {
                    return this.thePage < this.totalPages;
                },
                pageRange() {
                    const maxPagesToShow = 5; // Adjust the maximum number of pages to show in the pagination
                    const middlePage = Math.floor(maxPagesToShow / 2);
                    const startPage = Math.max(this.thePage - middlePage, 1);
                    const endPage = Math.min(startPage + maxPagesToShow - 1, this.totalPages);
                    const pages = [];
                    for (let i = startPage; i <= endPage; i++) {
                        pages.push(i);
                    }
                    if (startPage > 1) {
                        pages.unshift("...");
                    }
                    if (endPage < this.totalPages) {
                        pages.push("...");
                    }
                    return pages;
                },
                ELLIPSIS() {
                    return "...";
                },
            },
            methods: {
                initMap: function () {
                    const p = this.accommodationIndex;
                    const location = { lat: p.positionY, lng: p.positionX };
                    this.map = new google.maps.Map(document.getElementById("map"), {
                        // 中心點位置
                        center: location,
                        zoom: 14, // 地圖縮放比例 (0-20)
                        streetViewControl: true, // 是否顯示右下角街景小人
                        mapTypeControl: true // 使用者能否切換地圖樣式：一般、衛星圖等
                    });

                    let marker = new google.maps.Marker({
                        position: location,
                        map: this.map,
                        title: p.name
                    });
                    // info window
                    let infowindow = new google.maps.InfoWindow({
                        content: `<h6>${p.name}</h6>
                                             <small>${p.address}</small>` // 支援html
                    });

                    infowindow.open(this.map, marker);

                    // 監聽 marker click 事件
                    marker.addListener('click', e => {
                        infowindow.open(this.map, marker);
                    });

                    this.map.setOptions({
                        styles: [
                            {
                                featureType: 'poi.business',
                                stylers: [{
                                    visibility: 'off'
                                }]
                            }
                        ]
                    });
                    //this.calculateDrivingTime(location, [{ lat: this.products[1].positionY, lng: this.products[1].positionX }, { lat: this.products[2].positionY, lng: this.products[2].positionX }])
                },
                calculateDrivingTime: function calculateDrivingTimes(originLatLng, destinationLatLngs) {
                    const bounds = new google.maps.LatLngBounds();
                    const markersArray = [];

                    // initialize services
                    const geocoder = new google.maps.Geocoder();
                    const service = new google.maps.DistanceMatrixService();
                    // build request
                    const origin1 = originLatLng/* { lat: 55.93, lng: -3.118 } */;
                    const origin2 = "Greenwich, England";
                    const destination = destinationLatLngs/* { lat: 50.087, lng: 14.421 } */;
                    const request = {
                        origins: [origin1, origin2],
                        destinations: destination,
                        travelMode: google.maps.TravelMode.DRIVING,
                        unitSystem: google.maps.UnitSystem.METRIC,
                        avoidHighways: false,
                        avoidTolls: false,
                    };

                    // get distance matrix response
                    service.getDistanceMatrix(request).then((response) => {
                        let r = response.rows[0].elements[0]
                        console.log(r);
                        console.log(r.distance.value); // 距離 公尺
                        console.log(r.duration.value); // 時間 秒
                      
                        const originList = response.originAddresses;
                        const destinationList = response.destinationAddresses;
                    });
                },
                loadProducts: async function () {
                    let _this = this;
                    let request = {
                        keyword: _this.keyword,
                        page: _this.thePage,
                        pageSize: _this.pageSize,
                        grades: _this.selectedGrades,
                        aCategory: _this.selectedaCategories,
                        score: _this.selectedScore,
                        sCategory: _this.selectedServiceInfos,
                        regions: _this.selectedaRegions
                    };
                    console.log(request);
                    const response = await fetch(`https://localhost:7251/api/Accommodations`, {
                        method: "Post",
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(request)
                    });
                    const datas = await response.json();
                    console.log(datas);
                    _this.products = datas.items;
                    _this.totalPages = datas.totalPages;
                },
                showModal: async function (id) {
                    let _this = this;
                    const exampleModal = document.getElementById('exampleModal')
                    if (exampleModal) {
                        const response = await fetch(`https://localhost:7251/api/Accommodations/${id}`)
                        const result = await response.json();
                        const p = _this.accommodationIndex = result;
                        console.log(p);

                        _this.accommodationImage = p.images[0] ? p.images[0].image : null;
                        _this.accommodationServiceCId = p.services.map(function (s) {
                            return s.serviceInfoCategoryId;
                        });

                        _this.$refs.childRef.commentBrief(p.id);
                        const showMoreText = "...顯示更多";
                        const showLessText = "...顯示更少";
                        const lines = _this.temp = p.description.split('\n');
                        // 如果行數超過 5 行，僅保留前 5 行
                        if (lines.length > 5) {
                            _this.accommodationDescription = lines.slice(0, 5).join('<br>') + `<small id='small' style='color: #999'>${showMoreText}</small>`;
                        } else {
                            _this.accommodationDescription = lines.join('<br>');
                        }

                        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
                        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

                        // 可改寫VUE
                        const modalImg = exampleModal.querySelector('.product-info ul');
                        modalImg.innerHTML = "";
                        p.images.map(function (p) {
                            const ce = document.createElement('li');
                            ce.innerHTML = `<img src="../AccommodationImages/${p.image}"/>`;
                            modalImg.append(ce);
                        });

                        $('.product-info ul li img').click(function () {
                            var imgSrc = $(this).attr('src');
                            _this.accommodationImage = imgSrc;
                        })
                        _this.initMap(id);
                    }
                },
                showAllComment: function () {
                    let _this = this;
                    const swcollapse2 = document.getElementById("swcollapse2");
                    const collapse2 = document.getElementById("collapse2");
                    const topthree = document.getElementById("topthree");

                    const isCollapsed = swcollapse2.classList.contains('collapsed');
                    if (isCollapsed) {
                        // Collapse 已展開，這裡可以執行相關程式碼
                        topthree.style.display = 'block';
                        console.log("close");

                    }
                    else {
                        _this.$refs.childRef.commentDisplay();
                        topthree.style.display = 'none';
                        console.log("open");
                    }

                },
                clickHandler: function (value) {
                    let _this = this;
                    _this.thePage = value;
                    _this.loadProducts();
                },
                toggleSInfos: function (index) {
                    const sCategory = this.filterDto.serviceInfoes[index];
                    const sInfos = sCategory.infos;
                    if (this.selectedsCategories.includes(sCategory.name)) {
                        this.selectedServiceInfos = [...new Set([...this.selectedServiceInfos, ...sInfos])];
                    } else {
                        this.selectedServiceInfos = this.selectedServiceInfos.filter(item => !sInfos.includes(item));
                    }
                    this.showPages();
                },
                addCart: async function (roomId) {
                    const _this = this;
                    let selectedDays = $(`#datepicker-dp-${roomId} .datepicker__month-day--selected .rp`).map(function(){
                        return Number($(this).text());
                    }).get();
                    selectedDays.pop();

                    _this.cartProductId = selectedDays;

                    let request = {
                        roomProductId: _this.cartProductId,
                        quantity : Number($(`#pq-${roomId}`).val())
                    };

                    if(_this.toggle){
                        window.opener.postMessage(JSON.stringify(request), window.location.origin);
                    }else{
                        await fetch(`https://localhost:7145/Carts/AddAccommodation2Cart`, {
                            method: "Post",
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(request)
                        }).then((response) => {
                            response.text().then((data) => {
                                $('#Cart').html(data);
                                alert("已成功加入購物車");
                            })
                        });
                    }
                },
                showPages: function () {
                    let _this = this;
                    _this.thePage = 1;
                    _this.loadProducts();
                },
                toggleDescription: function () {
                    const showMoreText = "...顯示更多";
                    const showLessText = "...顯示更少";
                    const lines = this.temp;
                    const s = $('#small');
                    if (s[0]) {
                        if (!this.showFullDescription) {
                            this.accommodationDescription = lines.join("<br>") + `<small id="small" style="color: #999">${showLessText}</small>`;

                        } else {
                            this.accommodationDescription = lines.slice(0, 5).join('<br>') + `<small id="small" style="color: #999">${showMoreText}</small>`;
                        }
                        this.showFullDescription = !this.showFullDescription;
                    }
                },
                createdp: async function (id) {
                    const _this = this;
                    "use strict";
                    const response = await fetch(`https://localhost:7251/api/RoomProducts/${id}`);
                    const datas = await response.json();
                    const rps = datas.items;
                    const disabledDates = datas.disableDate;
                    const dpInput = document.getElementById(`dp-${id}`);
                    const pqInput = $(`#pq-${id}`);
                    const ptInput = $(`#tp-${id}`);
                    //let maxQuantity;

                    var hdpkr = new HotelDatepicker(dpInput, {
                        clearButton: true,
                        topbarPosition: 'bottom',
                        selectForward: true,
                        disabledDates: disabledDates,
                        enableCheckout: true,
                        extraDayText: function (date, attributes) {
                            for (var i = 0; i < rps.length; i++) {
                                if (date === fecha.format(new Date(rps[i].date), "YYYY-MM-DD") && attributes.class.includes("datepicker__month-day--visibleMonth")) {
                                    return `<br>$${rps[i].newPrice}<div class="d-none rp">${rps[i].id}</div>`;
                                }
                            }
                        },
                        endDate: rps[rps.length - 1].date
                    });

                    dpInput.addEventListener('afterClose', function () {
                        const value = this.value;
                        const pattern = /^(\d{4}-\d{2}-\d{2}) - (\d{4}-\d{2}-\d{2})$/;
                        const match = pattern.exec(value);
                        let total;

                        if (match) {
                            const startDate = new Date(match[1]);
                            const endDate = new Date(match[2]);

                            if (!isNaN(new Date(startDate)) && !isNaN(new Date(endDate))) {
                                total = rps.reduce((acc, item) => {
                                    const itemDate = new Date(item.date);
                                    if (itemDate >= startDate && itemDate < endDate) {
                                        acc.sum += item.newPrice;
                                        acc.quantity = Math.min(acc.quantity, item.quantity)
                                    }
                                    return acc;
                                }, { sum: 0, quantity: Infinity });

                                pqInput.attr("max", total.quantity).val(1);
                                ptInput.val(total.sum);

                                $(`#ptInput-${id}`).show();
                                pqInput.off('change');
                                pqInput.on('change', function () {
                                    if (pqInput.val() > total.quantity) {
                                        pqInput.val(total.quantity);
                                    } else if (pqInput.val() < 1) {
                                        pqInput.val(1);
                                    }
                                    ptInput.val(total.sum * pqInput.val());
                                })
                            }
                            else {
                                alert("請使用日期選取!");
                            }
                        }
                    }, false);
                },
                RecommendAccommodation: async function(x, y, name){
                    x = 121.12;
                    y = 22.79;

                    const location = { lat: y, lng: x };
                    let _this = this;
                    let modal = new bootstrap.Modal(document.getElementById("exampleModal"));

                    this.map = new google.maps.Map(document.getElementById("RecommendMap"), {
                        // 中心點位置
                        center: location,
                        zoom: 12, // 地圖縮放比例 (0-20)
                        streetViewControl: true, // 是否顯示右下角街景小人
                        mapTypeControl: true // 使用者能否切換地圖樣式：一般、衛星圖等
                    });
                    const N = window.location.search.replace('?Recommend=', '');
                    const topN = N > 0 ? N : 10;

                    const response = await fetch(`https://localhost:7251/api/Accommodations?lngX=${x}&latY=${y}&topN=${topN}`)
                    const result = await response.json();

                    _this.products = result;

                    console.log(result);

                    let markerCenter = new google.maps.Marker({
                        position: location,
                        //icon: "https://akveo.github.io/eva-icons/outline/png/128/gift-outline.png", // 自定義圖標，google也有提供5個預設的圖標，參考下方*1
                        map: _this.map,
                        animation: google.maps.Animation.DROP, // DROP掉下來、BOUNCE一直彈跳
                        draggable: false // true、false可否拖拉
                        });

                        markerCenter.addListener('click', e => {
                            infowindow.open(_this.map, markerCenter);
                        });

                        let centerInfowindow = new google.maps.InfoWindow({
                            content: `你的位置` // 支援html
                        });

                        centerInfowindow.open(_this.map, markerCenter);

                    result.forEach(r => {
                        let latLng = new google.maps.LatLng(r.positionY, r.positionX);

                        let marker = new google.maps.Marker({
                        position: latLng,
                        //icon: "https://akveo.github.io/eva-icons/outline/png/128/gift-outline.png", // 自定義圖標，google也有提供5個預設的圖標，參考下方*1
                        map: _this.map,
                        animation: google.maps.Animation.BOUNCE, // DROP掉下來、BOUNCE一直彈跳
                        draggable: false // true、false可否拖拉
                        });

                        let infowindow = new google.maps.InfoWindow({
                            content: `<h6>${r.name}</h6>
                                                    <small>${r.address}</small>` // 支援html
                        });

                        marker.addListener('mouseover', e => {
                            infowindow.open(_this.map, marker);
                        });

                        marker.addListener('mouseout', e => {
                            infowindow.close(_this.map, marker);
                        });

                        marker.addListener('click', e => {
                            _this.showModal(r.id)
                            modal.show();
                        });

                    });

                    this.map.setOptions({
                        styles: [
                            {
                                featureType: 'poi.business',
                                stylers: [{
                                    visibility: 'off'
                                }]
                            }
                        ]
                    });

                    alert("已幫你挑選10間精選住所")

                }
            },
            components: {
                dec
            }
        }
        var app = Vue.createApp(vueApp).mount("#app");

    </script>
}